From a40955a7237c1eff29e8bc4fe666a6e6b926b7d1 Mon Sep 17 00:00:00 2001
From: Peter Zhigalov <peter.zhigalov@gmail.com>
Date: Sat, 29 Oct 2022 03:34:56 +0700
Subject: [PATCH 6/8] Improve Windows 98 compatibility

---
 src/drivers/driver_ndis.c         | 11 +++++++++--
 src/l2_packet/l2_packet_winpcap.c |  8 ++++++--
 2 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/src/drivers/driver_ndis.c b/src/drivers/driver_ndis.c
index b32e009..3f1c1c6 100644
--- a/src/drivers/driver_ndis.c
+++ b/src/drivers/driver_ndis.c
@@ -2769,6 +2769,9 @@ static int wpa_driver_ndis_adapter_open(struct wpa_driver_ndis_data *drv)
 	char ifname[128];
 	os_snprintf(ifname, sizeof(ifname), "\\Device\\NPF_%s", drv->ifname);
 	drv->adapter = PacketOpenAdapter(ifname);
+	/* Win98 has ifnames without prefixes */
+	if (drv->adapter == NULL)
+		drv->adapter = PacketOpenAdapter(drv->ifname);
 	if (drv->adapter == NULL) {
 		wpa_printf(MSG_DEBUG, "NDIS: PacketOpenAdapter failed for "
 			   "'%s'", ifname);
@@ -2877,11 +2880,15 @@ static void * wpa_driver_ndis_init(void *ctx, const char *ifname)
 	drv->events = ndis_events_init(&drv->events_pipe, &drv->event_avail,
 				       drv->ifname, drv->adapter_desc);
 	if (drv->events == NULL) {
+		/* This is non-fatal error, ndis_events_init not work on Win98 */
+		/*
 		wpa_driver_ndis_deinit(drv);
 		return NULL;
+		*/
+	} else {
+		eloop_register_event(drv->event_avail, sizeof(drv->event_avail),
+				     wpa_driver_ndis_event_pipe_cb, drv, NULL);
 	}
-	eloop_register_event(drv->event_avail, sizeof(drv->event_avail),
-			     wpa_driver_ndis_event_pipe_cb, drv, NULL);
 #endif /* CONFIG_NDIS_EVENTS_INTEGRATED */
 
 #ifdef _WIN32_WCE
diff --git a/src/l2_packet/l2_packet_winpcap.c b/src/l2_packet/l2_packet_winpcap.c
index 545ed45..0bacde1 100644
--- a/src/l2_packet/l2_packet_winpcap.c
+++ b/src/l2_packet/l2_packet_winpcap.c
@@ -220,8 +220,12 @@ struct l2_packet_data * l2_packet_init(
 		os_memcpy(l2->own_addr, own_addr, ETH_ALEN);
 
 	if (l2_packet_init_libpcap(l2, protocol)) {
-		os_free(l2);
-		return NULL;
+		os_snprintf(l2->ifname, sizeof(l2->ifname), "%s", ifname);
+		/* Win98 has ifnames without prefixes */
+		if (l2_packet_init_libpcap(l2, protocol)) {
+			os_free(l2);
+			return NULL;
+		}
 	}
 
 	if (!rx_callback)
-- 
2.30.2

